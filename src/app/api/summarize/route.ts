import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY || '',
});

export async function POST(request: NextRequest) {
  try {
    const { text } = await request.json();

    if (!text || text.trim().length === 0) {
      return NextResponse.json(
        { error: 'æ–‡æœ¬å†…å®¹ä¸èƒ½ä¸ºç©º' },
        { status: 400 }
      );
    }

    if (!process.env.OPENAI_API_KEY) {
      return NextResponse.json(
        { error: 'OpenAI APIå¯†é’¥æœªé…ç½®ï¼Œè¯·åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®OPENAI_API_KEY' },
        { status: 500 }
      );
    }

    const completion = await openai.chat.completions.create({
      model: process.env.OPENAI_MODEL || 'gpt-4o',
      messages: [
        {
          role: 'system',
          content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¼šè®®è®°å½•åŠ©æ‰‹ã€‚è¯·å°†ä»¥ä¸‹ä¼šè®®è®°å½•å†…å®¹æ•´ç†æˆç»“æ„åŒ–çš„ä¼šè®®æ€»ç»“ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹markdownæ ¼å¼è¾“å‡ºï¼Œä½¿ç”¨ä¸°å¯Œçš„markdownè¯­æ³•ï¼š

# ğŸ“‹ ä¼šè®®æ€»ç»“

## ğŸ“… ä¼šè®®åŸºæœ¬ä¿¡æ¯
- **ä¼šè®®æ—¶é—´**ï¼š[æ ¹æ®å†…å®¹æ¨æ–­æˆ–è®°å½•çš„æ—¶é—´]
- **ä¼šè®®ä¸»é¢˜**ï¼š[æ ¹æ®å†…å®¹æ¨æ–­ä¼šè®®ä¸»é¢˜]
- **å‚ä¼šäººå‘˜**ï¼š[ä»å†…å®¹ä¸­æå–çš„å‚ä¼šäººå‘˜]
- **ä¼šè®®ç±»å‹**ï¼š[å¦‚ï¼šé¡¹ç›®è¯„å®¡ã€éœ€æ±‚è®¨è®ºã€è¿›åº¦æ±‡æŠ¥ç­‰]

## ğŸ¯ ä¸»è¦è®®é¢˜ä¸è®¨è®º

### è®®é¢˜1ï¼š[è®®é¢˜æ ‡é¢˜]
- **è®¨è®ºå†…å®¹**ï¼š[è¯¦ç»†è®¨è®ºå†…å®¹]
- **ç»“è®º**ï¼š[è¾¾æˆçš„ç»“è®ºæˆ–å†³å®š]

### è®®é¢˜2ï¼š[è®®é¢˜æ ‡é¢˜]
- **è®¨è®ºå†…å®¹**ï¼š[è¯¦ç»†è®¨è®ºå†…å®¹]
- **ç»“è®º**ï¼š[è¾¾æˆçš„ç»“è®ºæˆ–å†³å®š]

## âœ… å…³é”®å†³ç­–
> **é‡è¦å†³ç­–è®°å½•**

1. **[å†³ç­–æ ‡é¢˜1]**
   - å†³ç­–å†…å®¹ï¼š[å…·ä½“å†³ç­–å†…å®¹]
   - å†³ç­–åŸå› ï¼š[å†³ç­–ä¾æ®]
   - å½±å“èŒƒå›´ï¼š[å½±å“çš„å›¢é˜Ÿ/é¡¹ç›®]

2. **[å†³ç­–æ ‡é¢˜2]**
   - å†³ç­–å†…å®¹ï¼š[å…·ä½“å†³ç­–å†…å®¹]
   - å†³ç­–åŸå› ï¼š[å†³ç­–ä¾æ®]
   - å½±å“èŒƒå›´ï¼š[å½±å“çš„å›¢é˜Ÿ/é¡¹ç›®]

## ğŸ“ è¡ŒåŠ¨é¡¹ä¸ä»»åŠ¡åˆ†é…

| ä»»åŠ¡æè¿° | è´Ÿè´£äºº | æˆªæ­¢æ—¶é—´ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|--------|----------|--------|------|
| [ä»»åŠ¡1] | [å§“å] | [æ—¥æœŸ] | ğŸ”´é«˜/ğŸŸ¡ä¸­/ğŸŸ¢ä½ | â³å¾…å¼€å§‹ |
| [ä»»åŠ¡2] | [å§“å] | [æ—¥æœŸ] | ğŸ”´é«˜/ğŸŸ¡ä¸­/ğŸŸ¢ä½ | â³å¾…å¼€å§‹ |

## âš ï¸ é£é™©ä¸é—®é¢˜
- **é£é™©1**ï¼š[é£é™©æè¿°] - *ç¼“è§£æªæ–½*ï¼š[å»ºè®®æªæ–½]
- **é£é™©2**ï¼š[é£é™©æè¿°] - *ç¼“è§£æªæ–½*ï¼š[å»ºè®®æªæ–½]

## ğŸ“Š æ•°æ®ä¸æŒ‡æ ‡
å¦‚æœä¼šè®®æ¶‰åŠæ•°æ®è®¨è®ºï¼Œè¯·æ•´ç†ï¼š
- **å…³é”®æŒ‡æ ‡**ï¼š[é‡è¦æ•°æ®ç‚¹]
- **ç›®æ ‡å€¼**ï¼š[é¢„æœŸç›®æ ‡]
- **å½“å‰çŠ¶æ€**ï¼š[ç°çŠ¶æè¿°]

## ğŸ”„ ä¸‹æ¬¡ä¼šè®®å®‰æ’
- **å»ºè®®æ—¶é—´**ï¼š[å»ºè®®çš„ä¼šè®®æ—¶é—´]
- **å»ºè®®è®®é¢˜**ï¼š
  - [è®®é¢˜1]
  - [è®®é¢˜2]
- **éœ€è¦å‡†å¤‡çš„ææ–™**ï¼š[éœ€è¦æå‰å‡†å¤‡çš„å†…å®¹]

---

> **å¤‡æ³¨**ï¼šè¯·æ ¹æ®å®é™…ä¼šè®®å†…å®¹è°ƒæ•´å„éƒ¨åˆ†çš„è¯¦ç»†ç¨‹åº¦ï¼Œç¡®ä¿ä¿¡æ¯å‡†ç¡®ä¸”æ˜“äºç†è§£ã€‚`
        },
        {
          role: 'user',
          content: text
        }
      ],
      max_tokens: 2000,
      temperature: 0.7,
    });

    const summary = completion.choices[0]?.message?.content || '';

    return NextResponse.json({ summary });

  } catch (error) {
    console.error('OpenAI APIé”™è¯¯:', error);
    
    if (error instanceof Error) {
      if (error.message.includes('API key')) {
        return NextResponse.json(
          { error: 'OpenAI APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®' },
          { status: 401 }
        );
      }
      if (error.message.includes('quota')) {
        return NextResponse.json(
          { error: 'OpenAI APIé…é¢ä¸è¶³ï¼Œè¯·æ£€æŸ¥è´¦æˆ·ä½™é¢' },
          { status: 429 }
        );
      }
    }

    return NextResponse.json(
      { error: 'ç”Ÿæˆä¼šè®®æ€»ç»“æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' },
      { status: 500 }
    );
  }
}
